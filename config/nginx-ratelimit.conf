# Minimal Nginx Configuration for S3 Rate Limiting
# This is a lightweight rate limiter that forwards to Garage

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    gzip on;

    # Rate limiting zones
    # ip_hash: Rate limit per client IP
    # zone=ip_limit:10m: 10MB zone to store rate limit state
    # rate=100r/s: 100 requests per second per IP
    limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=burst_limit:10m rate=1000r/m;

    upstream garage_s3 {
        server garage:3901;
        keepalive 32;
    }

    server {
        listen 3900 default_server;
        server_name _;

        # Disable request body size limit for large S3 uploads
        client_max_body_size 0;
        client_body_buffer_size 1m;

        # Disable proxy buffering for streaming/large uploads
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_max_temp_file_size 0;

        # Rate limiting
        # burst=200: Allow bursts up to 200 requests
        # nodelay: No delay for requests within burst
        limit_req zone=ip_limit burst=200 nodelay;

        location / {
            proxy_pass http://garage_s3;

            # Critical S3 headers
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;

            # Connection settings
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;

            # Pass through large request bodies
            proxy_request_buffering off;
            proxy_buffering off;

            # Handle response headers
            proxy_pass_header Authorization;
            proxy_pass_header Content-Type;
            proxy_pass_header Content-Length;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
